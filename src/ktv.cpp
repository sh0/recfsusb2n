#include <unistd.h>
#include <string.h>

#include "ktv.hpp"

//#define DEBUG_CAS

#define TBL_SZ(a) (sizeof(a)/sizeof(*a))

inline void miliWait( int s )	{ usleep(s*1000); }

/* */

KtvDevice::KtvDevice (EM2874Device *pDev)
: Tuner_InitDone(false)
{
	usbDev = pDev;
}

KtvDevice::~KtvDevice()
{
	if( usbDev != NULL ) {
		usbDev->writeReg( EM2874_REG_TS_ENABLE, 0 );
		usbDev->writeReg( EM28XX_REG_GPIO, 0xFE );
	}
}

bool KtvDevice::DeMod_Write (const uint8_t idx, const uint8_t val)
{
	usbDev->writeReg(EM28XX_REG_I2C_CLK, 0x44);
	uint8_t buf[] = {idx, val};
	return usbDev->writeI2C(DEMOD_ADDR, 2, buf, true);
}

uint8_t KtvDevice::DeMod_Read (const uint8_t idx)
{
	usbDev->writeReg(EM28XX_REG_I2C_CLK, 0x44);
	uint8_t val = idx;
	usbDev->writeI2C(DEMOD_ADDR, 1, &val, false);
	usbDev->readI2C(DEMOD_ADDR, 1, &val, true);
	return val;
}

bool KtvDevice::Tuner_I2C_Write (uint8_t* buf, const int len)
{
	if(!DeMod_Write(0xFE, 0))	return false;
	usbDev->writeReg(EM28XX_REG_I2C_CLK, 0x44);
	usbDev->writeI2C(TUNER_ADDR, len, buf, true);
	DeMod_Write(0xFE, 1);
	return true;
}

bool KtvDevice::Tuner_I2C_Read (uint8_t* wbuf, const int wlen, uint8_t* rbuf, const int rlen)
{
	if(!DeMod_Write(0xFE, 0))	return false;
	usbDev->writeReg(EM28XX_REG_I2C_CLK, 0x44);
	usbDev->writeI2C(TUNER_ADDR, wlen, wbuf, false);
	usbDev->readI2C(TUNER_ADDR, rlen, rbuf, true);
	DeMod_Write(0xFE, 1);
	return true;
}

/*
*/

uint8_t KtvDevice::DeMod_GetSequenceState()
{
	return DeMod_Read(0x0A);
}

void KtvDevice::CN_Counter_Reset()
{
	uint8_t val = DeMod_Read(0x45);
	DeMod_Write(0x45, val | 0x10);
	DeMod_Write(0x45, val & 0x6f);
}

bool KtvDevice::CN_Flag_chk ()
{
	uint8_t val = DeMod_Read(0x45);
	return (val & 0x40) != 0;
}

uint16_t KtvDevice::CN_Value_Get ()
{
	return (DeMod_Read(0x46) << 8) | DeMod_Read(0x47);
}

static unsigned int CNval_to_CN10 ( uint16_t cn )
{
	static const uint16_t cnValue[] = {
						11622,	10279,	9089,	8042,	7137,
	6342,	5641,	5030,	4474,	3988,	3556,	3180,	2841,	2541,	2276,
	2038,	1800,	1625,	1462,	1324,	1175,	1063,	980,	907,	840,
	788,	740,	695,	653,	614,	577,	542,	510
	};

	if ( cn >= cnValue[0] ) return 2;

	int max = TBL_SZ(cnValue) - 1;
	if ( cn <= 510 ) return 3702;

	int min = 1;
	do {
		int mid = (min + max) >> 1;
		if ( cn >= cnValue[mid] ) {
			max = mid;
		} else {
			min = mid + 1;
		}
	} while ( min < max );
	unsigned int base = cnValue[min];
	int d = cnValue[min-1] - base;
	return (min+5)*100 - (signed)((cn - base)*100 - (d >> 1)) / d;
}

unsigned int KtvDevice::DeMod_GetQuality ()
{
	unsigned val = DeMod_GetSequenceState();
	if( val < 4 ) {
		return 0;
	}

	if ( CN_Flag_chk() ) {
		val = CN_Value_Get();
		CN_Counter_Reset();
		return CNval_to_CN10( val );
	}
	return 0;
}

/*
*/

Ktv1Device::Ktv1Device (EM2874Device *pDev) : KtvDevice(pDev)
{
}

Ktv1Device::~Ktv1Device()
{
	if( usbDev != NULL ) {
		tuner_r[0x05] ^= (tuner_r[0x05] ^ 0xc0) & 0xe0;	// PowerState = Xtal ON
		Tuner_RegWrite(0x05, 1);
	}
}

void Ktv1Device::Tuner_RegWrite (const uint8_t offset, const int len)
{
	if ( len > 0 && offset < 39 && offset + len <= 39 ) {
		uint8_t buf[40];
		buf[0] = offset;
		memcpy( buf+1, tuner_r + offset, len );
		Tuner_I2C_Write( buf, len + 1);
	}
}

void Ktv1Device::Tuner_RegRead (const uint8_t offset, const int len)
{
	uint8_t val = offset;
	Tuner_I2C_Read(&val, 1, tuner_r + offset, len);
}

typedef struct { unsigned int idx; unsigned int val; } TableData;

static uint16_t binarySearch ( const TableData* tbl, const int size, const uint32_t idx )
{
  int min = 0, max = size - 1;
  do {
    int mid = (min + max) >> 1;
    if ( idx <= tbl[mid].idx ) {
      max = mid;
    } else {
      min = mid + 1;
    }
  } while ( min < max );
  return tbl[min].val;
}
//
void Ktv1Device::InitTuner ()
{
	static const uint8_t initData[] = {
	0x01, 0x26,
		0x08, 0x80, 0xc6, 0xdf, 0x16, 0x60, 0x80,
		0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0xfc, 0x01, 0x84, 0x41, 0x01, 0x84, 0x40, 0x07,
		0x00, 0x00, 0x96, 0x33, 0xc1, 0x00, 0x8f, 0x00,
		0x00, 0x8c, 0x00, 0x20, 0xb3, 0x48, 0xb0,
	// Setup AGC1 gain
	0x20, 0x01, 0x00, 
	0x20, 0x01, 0x03,
	0x20, 0x01, 0x43,
	0x20, 0x01, 0x4c,
	// Setup AGC2 gain
	0x23, 0x01, 0xa0,
	0x23, 0x01, 0xa7,
	0x23, 0x01, 0xe7,
	0x23, 0x01, 0xec,

	// IRCAL low band Init
	0x05, 0x0b, 0x1f, 0x66, 0x81, 0xcc, 0x6c, 0x00, 0x00, 0xcd, 0x77, 0x08, 0x00,
	0x13, 0x01, 0x61,
	0xfe, 1,
	0x13, 0x01, 0x41,
	0xfe, 5,
	// Launch detector
	0x03, 0x01, 0xc6,
	0xfe, 5,
	// CALPLL update
	0x05, 0x07, 0x1f, 0x66, 0x85, 0xcb, 0x66, 0x70, 0x00,
	0xfe, 5,
	// Launch optimization algorithm
	0x04, 0x01, 0xdf,
	0xfe, 30,

	// IRCAL mid band Init
	0x05, 0x0b, 0x1f, 0x66, 0x82, 0xa8, 0x66, 0x00, 0x00, 0xa9, 0x73, 0x1a, 0x00,
	0xfe, 5,
	// Launch detector
	0x03, 0x01, 0xc6,
	0xfe, 5,
	// CALPLL update
	0x05, 0x07, 0x1f, 0x66, 0x86, 0xa8, 0x66, 0xa0, 0x00,
	0xfe, 5,
	// Launch optimize..
	0x04, 0x01, 0xdf,
	0xfe, 30,

	// IRCAL high band Init
	0x05, 0x0b, 0x1f, 0x66, 0x83, 0x98, 0x65, 0x00, 0x00, 0x99, 0x71, 0xcd, 0x00,
	0xfe, 5,
	// Launch detector
	0x03, 0x01, 0xc6,
	0xfe, 5,
	// CALPLL update
	0x05, 0x07, 0x1f, 0x66, 0x87, 0x98, 0x65, 0x50, 0x00,
	0xfe, 5,
	// Launch optimize..
	0x04, 0x01, 0xdf,
	0xfe, 30,
	// Back to normal mode
	0x06, 0x01, 0x64,
	// Synchronize
	0x03, 0x01, 0xc6,
	0xff
	};

	for ( const uint8_t* dp = initData; *dp != 0xff; ) {
		if(*dp == 0xfe) {
			miliWait( dp[1] );
			dp += 2;
			continue;
		}
		memcpy( tuner_r+dp[0], dp+2, dp[1] );
		Tuner_RegWrite( dp[0], dp[1] );
		dp += dp[1] + 2;
	}

	tuner_r[0x05] = 0x19;	// PowerState = Normal, STD=19
	tuner_r[0x06] = 0x60;	// IF_LEVEL=0, CAL_MODE=0
	tuner_r[0x0C] |= 0x80;	// IF_NOTCH=1
	tuner_r[0x25] = 0x37;	// EB22=37
	Tuner_RegWrite(0x05, 2);
	Tuner_RegWrite(0x0c, 1);
	Tuner_RegWrite(0x25, 1);
	miliWait(10);

	Tuner_InitDone = true;
}


static const TableData tbl_rf_band[] = {
{ 152600, 2 },
{ 164700, 3 },
{ 203500, 4 },
{ 457800, 5 },
{ 865000, 6 }
};
static const TableData tbl_gain_taper[] = {
{ 100300, 0x08 }, { 106900, 0x07 }, { 113400, 0x06 }, { 119900, 0x05 },
{ 126500, 0x04 }, { 133000, 0x03 }, { 139500, 0x02 }, { 146100, 0x01 },
{ 152600, 0x00 }, { 154300, 0x1f }, { 156100, 0x1e }, { 157800, 0x1d },
{ 159500, 0x1c }, { 161200, 0x1b }, { 163000, 0x1a }, { 164700, 0x19 },
{ 170200, 0x17 }, { 175800, 0x16 }, { 181300, 0x15 }, { 186900, 0x14 },
{ 192400, 0x13 }, { 198000, 0x12 }, { 203500, 0x11 }, { 216200, 0x14 },
{ 228900, 0x13 }, { 241600, 0x12 }, { 254400, 0x11 }, { 267100, 0x10 },
{ 279800, 0x0f }, { 292500, 0x0e }, { 305200, 0x0d }, { 317900, 0x0c },
{ 330700, 0x0b }, { 343400, 0x0a }, { 356100, 0x09 }, { 368800, 0x08 },
{ 381500, 0x07 }, { 394200, 0x06 }, { 406900, 0x05 }, { 419700, 0x04 },
{ 432400, 0x03 }, { 445100, 0x02 }, { 457800, 0x01 }, { 476300, 0x19 },
{ 494800, 0x18 }, { 513300, 0x17 }, { 531800, 0x16 }, { 550300, 0x15 },
{ 568900, 0x14 }, { 587400, 0x13 }, { 605900, 0x12 }, { 624400, 0x11 },
{ 642900, 0x10 }, { 661400, 0x0f }, { 679900, 0x0e }, { 698400, 0x0d },
{ 716900, 0x0c }, { 735400, 0x0b }, { 753900, 0x0a }, { 772500, 0x09 }
};

static const TableData tbl_bp_filter[] = {
{ 100000, 2 }, { 140000, 3 }, { 170000, 4 }, { 180000, 5 }, { 865000, 6 }
};

void Ktv1Device::SetFrequency (unsigned int freq_khz)
{
	tuner_r[0x05] = 0x19;	// PowerState = Normal, STD=19
	tuner_r[0x06] = 0x64;	// IF_LEVEL=1, CAL_MODE=0
	tuner_r[0x0C] |= 0x80;	// IF_NOTCH=1
	tuner_r[0x25] = 0x37;	// EB22=37
	Tuner_RegWrite(0x05, 2);
	Tuner_RegWrite(0x0c, 1);
	Tuner_RegWrite(0x25, 1);
	tuner_r[0x1b] &= ~0x30;
	Tuner_RegWrite(0x1b, 1);

	tuner_r[0x03] = (tuner_r[0x03] & 0xc0) | ::binarySearch( tbl_bp_filter, TBL_SZ( tbl_bp_filter ), freq_khz );
	tuner_r[0x04] = (::binarySearch( tbl_rf_band, TBL_SZ( tbl_rf_band ), freq_khz ) << 5)
	| (::binarySearch( tbl_gain_taper, TBL_SZ( tbl_gain_taper ), freq_khz ));
	Tuner_RegWrite(0x03, 1);

	static const TableData km[] = {
	{ 350000, 0x30 },	{ 720000, 0x24 },	{ 865000, 0x3c }
	};
	tuner_r[0x1c] = ::binarySearch( km, TBL_SZ( km ), freq_khz ) | (tuner_r[0x1c] & 0x83);
	Tuner_RegWrite( 0x1c, 1 );

	tuner_r[0x13] = (tuner_r[0x13] & 0x07) | 0x60;	// LO_FORCESRCE=1
	tuner_r[0x16] |= 0x20;	// CAL_FORCESRCE=1
	tuner_r[0x1d] = 0;		// RFC_CPROG = 0
	tuner_r[0x23] &= ~0x20;	// FORCE_LOCK=0
	Tuner_RegWrite(0x13, 1);
	Tuner_RegWrite(0x16, 1);
	Tuner_RegWrite(0x1d, 1);
	Tuner_RegWrite(0x23, 1);
	tuner_r[0x06] |= 0x3;	// CAL_MODE=3
	calc_cal_pll(freq_khz + 3000);
	calc_main_pll(freq_khz + 4000);
	Tuner_RegWrite( 0x05, 11 );
	miliWait(5);
	Tuner_RegWrite( 0x04, 1 );	Tuner_RegWrite( 0x03, 1 );	// sync
	Tuner_RegWrite( 0x04, 1 );	Tuner_RegWrite( 0x03, 1 );

	tuner_r[0x13] &= ~0x20;	// LO_FORCESRCE=0
	tuner_r[0x16] &= ~0x20;	// CAL_FORCESRCE=0
	Tuner_RegWrite(0x13, 1);
	Tuner_RegWrite(0x16, 1);
	miliWait(10);

	tuner_r[0x23] |= 0x20;	// FORCE_LOCK=1
	Tuner_RegWrite(0x23, 1);
	miliWait(60);

	tuner_r[0x06] &= ~0x3;	// CAL_MODE=0
	Tuner_RegWrite(0x06, 1);
	Tuner_RegWrite(0x03, 1);	// sync
	//

	static const TableData ir_measure[] = {
	{ 200000, 5 }, { 600000, 6 }, { 865000, 7 }
	};

	tuner_r[0x07] ^= (::binarySearch( ir_measure, TBL_SZ( ir_measure ), freq_khz ) ^ tuner_r[0x07]) & 0x07;
	
	tuner_r[0x10] &= ~0x03;
	Tuner_RegWrite(0x10, 1);

	calc_main_pll( freq_khz + 4000 );
	Tuner_RegWrite( 0x01, 15 );
	tuner_r[0x13] |= 0x20;	// LO_FORCESRCE=1
	Tuner_RegWrite(0x13, 1);
	miliWait(1);
	tuner_r[0x13] &= ~0x20;	// LO_FORCESRCE=0
	Tuner_RegWrite(0x13, 1);
	miliWait(20);
	tuner_r[0x05] |= 0x04;	// STD[2] = 1 : Switch to RFAGC to normal speed mode
	Tuner_RegWrite(0x05, 1);
	miliWait(5);
}

void Ktv1Device::InitDeMod()
{
	static uint8_t tbl[][2] = {
	{ 0x70, 0x0f }, { 0x70, 0xff }, { 0x09, 0x3e },
	{ 0x50, 0xd1 }, { 0x51, 0x22 },
	{ 0x39, 0x01 },
	{ 0x28, 0x2a }, { 0x29, 0x00 }, { 0x2a, 0xff }, { 0x2b, 0x80 },
	{ 0x3b, 0x21 }, { 0x3c, 0x38 },
	{ 0x28, 0x20 }, { 0x29, 0x3e }, { 0x2a, 0xe0 }, { 0x2b, 0x8f },
	{ 0x01, 0x0d },
	{ 0x04, 0x08 }, { 0x05, 0x03 },
	{ 0x04, 0x0e }, { 0x05, 0x00 },
	{ 0x04, 0x0f }, { 0x05, 0x39 },
	{ 0x04, 0x0b }, { 0x05, 0x78 },
	{ 0x04, 0x00 }, { 0x05, 0x00 },
	{ 0x04, 0x01 }, { 0x05, 0x1e },
	{ 0x04, 0x02 }, { 0x05, 0x07 },
	{ 0x04, 0x03 }, { 0x05, 0xd0 },
	{ 0x04, 0x09 }, { 0x05, 0x00 },
	{ 0x04, 0x0a }, { 0x05, 0xff },
	{ 0x04, 0x27 }, { 0x05, 0x00 },
	{ 0x04, 0x28 }, { 0x05, 0x00 },
	{ 0x04, 0x1e }, { 0x05, 0x00 },
	{ 0x04, 0x29 }, { 0x05, 0x0a },
	{ 0x04, 0x32 }, { 0x05, 0x0a },
	{ 0x04, 0x14 }, { 0x05, 0x02 },
	{ 0x04, 0x04 }, { 0x05, 0x00 },
	{ 0x04, 0x05 }, { 0x05, 0x22 },
	{ 0x04, 0x06 }, { 0x05, 0x0e },
	{ 0x04, 0x07 }, { 0x05, 0xd8 },
	{ 0x04, 0x12 }, { 0x05, 0x00 },
	{ 0x04, 0x13 }, { 0x05, 0xff },
	{ 0x04, 0x15 }, { 0x05, 0x55 },
	{ 0x04, 0x16 }, { 0x05, 0x00 },
	{ 0x52, 0x01 },
	{ 0x50, 0xa7 }, { 0x51, 0x00 },
	{ 0x50, 0xa8 }, { 0x51, 0x0f },
	{ 0x50, 0xa9 }, { 0x51, 0xff },
	{ 0x50, 0xaa }, { 0x51, 0x00 },
	{ 0x50, 0xab }, { 0x51, 0xff },
	{ 0x50, 0xac }, { 0x51, 0xff },
	{ 0x50, 0xad }, { 0x51, 0x00 },
	{ 0x50, 0xae }, { 0x51, 0xff },
	{ 0x50, 0xaf }, { 0x51, 0xff },
	{ 0x5e, 0x07 },
	{ 0x50, 0xdc },	{ 0x51, 0x03 },
	{ 0x50, 0xdd }, { 0x51, 0xff },
	{ 0x50, 0xde }, { 0x51, 0x3f },
	{ 0x50, 0xdf }, { 0x51, 0xff },
	{ 0x50, 0xe0 }, { 0x51, 0x3f },
	{ 0x50, 0xe1 }, { 0x51, 0xff },
	{ 0x50, 0xb0 }, { 0x51, 0x07 },
	{ 0x50, 0xb2 }, { 0x51, 0x03 },
	{ 0x50, 0xb3 }, { 0x51, 0xff },
	{ 0x50, 0xb4 }, { 0x51, 0x3f },
	{ 0x50, 0xb5 }, { 0x51, 0xff },
	{ 0x50, 0xb6 }, { 0x51, 0x3f },
	{ 0x50, 0xb7 }, { 0x51, 0xff },
	{ 0x50, 0x51 }, { 0x51, 0x04 },
	{ 0x53, 0x00 }, { 0x53, 0x07 },
	{ 0x5f, 0x00 }, { 0x5f, 0x07 },
	{ 0x50, 0xb1 }, { 0x51, 0x00 },
	{ 0x45, 0x04 },
	{ 0x50, 0x50 }, { 0x51, 0x02 },
	{ 0x48, 0x04 },
	{ 0x50, 0xd5 }, { 0x51, 0x01 },
	{ 0x50, 0xd6 }, { 0x51, 0x17 },
	{ 0x50, 0xd2 }, { 0x51, 0x03 },
	{ 0x50, 0xd7 }, { 0x51, 0xb7 },
	{ 0x28, 0x74 }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0xff },
	{ 0x28, 0x46 }, { 0x29, 0x00 }, { 0x2a, 0x1a }, { 0x2b, 0x0c },
	{ 0x04, 0x40 }, { 0x05, 0x00 },
	{ 0x28, 0x00 }, { 0x2b, 0x08 },
	{ 0x28, 0x05 }, { 0x2b, 0x00 },
	{ 0x1c, 0x01 },
	{ 0x28, 0x06 }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x1f },
	{ 0x28, 0x07 }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x18 },
	{ 0x28, 0x08 }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x12 },
	{ 0x28, 0x09 }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x30 },
	{ 0x28, 0x0a }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x37 },
	{ 0x28, 0x0b }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x02 },
	{ 0x28, 0x0c }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x09 },
	{ 0x28, 0x0d }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x06 },
	{ 0x28, 0x0e }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x7b },
	{ 0x28, 0x0f }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x76 },
	{ 0x28, 0x10 }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x7d },
	{ 0x28, 0x11 }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x08 },
	{ 0x28, 0x12 }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x0b },
	{ 0x28, 0x13 }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x00 },
	{ 0x28, 0x14 }, { 0x29, 0x00 }, { 0x2a, 0x01 }, { 0x2b, 0xf2 },
	{ 0x28, 0x15 }, { 0x29, 0x00 }, { 0x2a, 0x01 }, { 0x2b, 0xf3 },
	{ 0x28, 0x16 }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x05 },
	{ 0x28, 0x17 }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x16 },
	{ 0x28, 0x18 }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x0f },
	{ 0x28, 0x19 }, { 0x29, 0x00 }, { 0x2a, 0x07 }, { 0x2b, 0xef },
	{ 0x28, 0x1a }, { 0x29, 0x00 }, { 0x2a, 0x07 }, { 0x2b, 0xd8 },
	{ 0x28, 0x1b }, { 0x29, 0x00 }, { 0x2a, 0x07 }, { 0x2b, 0xf1 },
	{ 0x28, 0x1c }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x3d },
	{ 0x28, 0x1d }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0x94 },
	{ 0x28, 0x1e }, { 0x29, 0x00 }, { 0x2a, 0x00 }, { 0x2b, 0xba },
	{ 0x50, 0x1e }, { 0x51, 0x5d },
	{ 0x50, 0x22 }, { 0x51, 0x00 },
	{ 0x50, 0x23 }, { 0x51, 0xc8 },
	{ 0x50, 0x24 }, { 0x51, 0x00 },
	{ 0x50, 0x25 }, { 0x51, 0xf0 },
	{ 0x50, 0x26 }, { 0x51, 0x00 },
	{ 0x50, 0x27 }, { 0x51, 0xc3 },
	{ 0x50, 0x39 }, { 0x51, 0x02 },
	{ 0x28, 0x6a }, { 0x29, 0x00 }, { 0x2a, 0x02 }, { 0x2b, 0xf0 }
	};
	for ( unsigned int i = 0; i < TBL_SZ( tbl ); i++ ) {
		DeMod_Write(tbl[i][0], tbl[i][1]);
	}
}

void Ktv1Device::ResetDeMod ()
{
	static uint8_t tbl[][2] = {
		{0x71, 0x00}
		,{0x08, 0x01}
		,{0x70, 0xf0}
		,{0x70, 0xff}
		,{0x08, 0x00}
		};
	for ( unsigned int i = 0; i < TBL_SZ( tbl ); i++ ) {
		DeMod_Write(tbl[i][0], tbl[i][1]);
	}
}

void Ktv1Device::calc_cal_pll (const unsigned int freq_khz)
{
	static const TableData cal_pll[] = {
	{  73250, 0xcc60 }, {  79875, 0xcb58 }, {  87875, 0xca50 }, {  97625, 0xc948 },
	{ 109875, 0xc840 }, { 125625, 0xc338 }, { 135250, 0xbd34 }, { 146500, 0xbc30 },
	{ 146600, 0xbb2c }, { 175750, 0xba28 }, { 195250, 0xb924 }, { 219750, 0xb820 },
	{ 251250, 0xb31c }, { 270500, 0xad1a }, { 293000, 0xac18 }, { 319000, 0xab16 },
	{ 351500, 0xaa14 }, { 390500, 0xa912 }, { 439500, 0xa810 }, { 502500, 0xa30e },
	{ 541000, 0x9d0d }, { 586000, 0x9c0c }, { 639000, 0x9b0b }, { 703000, 0x9a0a },
	{ 781000, 0x9909 }, { 879000, 0x9808 }
	};

	unsigned int v = ::binarySearch( cal_pll, TBL_SZ( cal_pll ), freq_khz );
	tuner_r[0x08] = v >> 8;

	v = ((freq_khz * (v & 0xff)) << 7) / 125;

	tuner_r[0x09] = (v >> 16) & 0x7f;
	tuner_r[0x0a] = v >> 8;
	tuner_r[0x0b] = v;
}

void Ktv1Device::calc_main_pll (const unsigned int freq_khz)
{
	static const TableData main_pll[] = {
	{  90250, 0x4b58 }, {  99375, 0x4a50 }, { 110375, 0x4948 }, { 124250, 0x4840 },
	{ 132500, 0x3f3c }, { 142000, 0x3e38 }, { 152750, 0x3d34 }, { 165500, 0x3c30 },
	{ 180500, 0x3b2c }, { 198750, 0x3a28 }, { 220750, 0x3924 }, { 248500, 0x3820 },
	{ 265000, 0x2f1e }, { 284000, 0x2e1c }, { 305500, 0x2d1a }, { 331000, 0x2c18 },
	{ 361000, 0x2b16 }, { 397500, 0x2a14 }, { 441500, 0x2912 }, { 497000, 0x2810 },
	{ 530000, 0x1f0f }, { 568000, 0x1e0e }, { 611000, 0x1d0d }, { 662000, 0x1c0c },
	{ 722000, 0x1b0b }, { 795000, 0x1a0a }, { 883000, 0x1909 }
	};

	unsigned int v = ::binarySearch( main_pll, TBL_SZ( main_pll ), freq_khz );
	unsigned int w = v & 0xff;
	tuner_r[0x0c] ^= ((v >> 8) ^ tuner_r[0x0c]) & 0x7f;

	if((freq_khz % 1000) == 143) {
		// 1/7 MHzを極力正確に表現
		v = ((freq_khz - 143) * w) << 7;
		v += (w * 128000) / 7;
	}else{
		v = (freq_khz * w) << 7;
	}
	v /= 125;

	tuner_r[0x0d] = (v >> 16) & 0x7f;
	tuner_r[0x0e] = v >> 8;
	tuner_r[0x0f] = v;
}

/*
*/

Ktv2Device::Ktv2Device (EM2874Device *pDev) : KtvDevice(pDev)
{
}

Ktv2Device::~Ktv2Device()
{
	static uint8_t rData[] = { 0x01,0, 0x0f,0 };
	if( usbDev != NULL ) {
		Tuner_I2C_Write(rData, TBL_SZ(rData));	// enter standby mode
	}
}

void Ktv2Device::InitTuner ()
{	
	static uint8_t initData[] = {
		0x02,0x00, 0x03,0x40, 0x05,0x04, 0x06,0x10,
		0x2e,0x15, 0x30,0x10, 0x45,0x58, 0x48,0x19,
		0x52,0x03, 0x53,0x44, 0x6a,0x4b, 0x76,0x00,
		0x78,0x18, 0x7a,0x17, 0x85,0x06, 0x01,0x01};
	uint8_t d = 0xff;
	Tuner_I2C_Write(&d, 1);
	miliWait(1);
	Tuner_I2C_Write(initData, TBL_SZ(initData));
	miliWait(5);
	Tuner_InitDone = true;
}

void Ktv2Device::SetFrequency (unsigned int freq_khz)
{
	static uint8_t tuneData[] = {
		0x0f,0x00, 0x0c,0x15,
		0x0d,0xc9, 0x0e,0x83,
		0x1f,0x87, 0x20,0x1f, 0x21,0x87, 0x22,0x1f,
		0x80,0x41, 0x0f,0x01};

	unsigned int dig_rf_freq = (freq_khz << 3) / 125U;
	tuneData[ 5] = (uint8_t)dig_rf_freq;
	tuneData[ 7] = dig_rf_freq >> 8;
	tuneData[17] = (freq_khz < 333000U) ? 0x01 : 0x41;

	Tuner_I2C_Write(tuneData, TBL_SZ(tuneData));
	miliWait(15);
}

void Ktv2Device::InitDeMod()
{
	static uint8_t tbl[][2] = {
		{0x70, 0x0f},{0x70, 0xff},{0x08, 0x01}
		,{0x73, 0x00},{0x08, 0x00},{0xd0, 0x04}
		,{0x06, 0xff}
		,{0x1f, 0x0f}
		,{0x1c, 0x01}
		,{0x28, 0x2a},{0x29, 0x00},{0x2a, 0x89},{0x2b, 0x37}
		,{0x28, 0x20},{0x29, 0x1f},{0x2a, 0x6f},{0x2b, 0x27}
		,{0x28, 0x22},{0x29, 0x00},{0x2a, 0x1f},{0x2b, 0xef}
		,{0x01, 0x09}
		,{0x04, 0x08},{0x05, 0x24}
		,{0x04, 0x1b},{0x05, 0x00}
		,{0x04, 0x0e},{0x05, 0x00}
		,{0x04, 0x0f},{0x05, 0x32}
		,{0x04, 0x0b},{0x05, 0x78}
		,{0x04, 0x00},{0x05, 0x00}
		,{0x04, 0x01},{0x05, 0x35}
		,{0x04, 0x02},{0x05, 0x07}
		,{0x04, 0x03},{0x05, 0xd0}
		,{0x04, 0x09},{0x05, 0x00}
		,{0x04, 0x0a},{0x05, 0xff}
		,{0x04, 0x29},{0x05, 0x32}
		,{0x04, 0x32},{0x05, 0x32}
		,{0x04, 0x27},{0x05, 0x00}
		,{0x04, 0x14},{0x05, 0x02}
		,{0x04, 0x04},{0x05, 0x00}
		,{0x04, 0x05},{0x05, 0x22}
		,{0x04, 0x06},{0x05, 0x0e}
		,{0x04, 0x07},{0x05, 0xd8}
		,{0x04, 0x12},{0x05, 0x00}
		,{0x04, 0x13},{0x05, 0xff}
		,{0x04, 0x15},{0x05, 0x4e}
		,{0x04, 0x16},{0x05, 0x20}
		,{0x04, 0x1e},{0x05, 0x00}
		,{0x3b, 0x05},{0x3c, 0x01}
		,{0x3b, 0x1f},{0x3c, 0x08}
		,{0x28, 0x03},{0x29, 0x00},{0x2a, 0x62},{0x2b, 0x11}
		,{0x28, 0x3c},{0x29, 0x00},{0x2a, 0x02},{0x2b, 0x00}
		,{0x28, 0x7f},{0x29, 0x00},{0x2a, 0x00},{0x2b, 0x00}
		,{0x28, 0x79},{0x29, 0x00},{0x2a, 0x00},{0x2b, 0x03}
		,{0x4f, 0x13}
		,{0x28, 0x3e},{0x29, 0x00},{0x2a, 0x1c},{0x2b, 0x84}
		,{0x3b, 0x23},{0x3c, 0x00}
		,{0x3b, 0x48},{0x3c, 0x02}
		,{0x3b, 0x0c},{0x3c, 0x59}
		,{0x50, 0x26},{0x51, 0x01}
		,{0x50, 0x27},{0x51, 0x04}
		,{0x28, 0x6a},{0x29, 0x00},{0x2a, 0x00},{0x2b, 0x3c}
		,{0x40, 0x6e},{0x41, 0x70}
		,{0x28, 0x5a},{0x29, 0x00},{0x2a, 0x00},{0x2b, 0x28}
		,{0x14, 0x0a}
		,{0x3b, 0x0a},{0x3c, 0x02}
		,{0x3b, 0x0b},{0x3c, 0x20}
		,{0x40, 0x6c},{0x41, 0x60}
		,{0x3b, 0x6c},{0x3c, 0x72}
		,{0x3b, 0x74},{0x3c, 0x20}
		,{0x3b, 0x65},{0x3c, 0x05}
		,{0x3b, 0x7d},{0x3c, 0x02}
		,{0x3b, 0x1e},{0x3c, 0x8f}
		,{0x3b, 0x20},{0x3c, 0x28}
		,{0x24, 0x80},{0x25, 0xa2},{0x26, 0x91},{0x27, 0xa2}
		,{0x28, 0x46},{0x29, 0x00},{0x2a, 0x2d},{0x2b, 0x0a}
		,{0x3b, 0x24},{0x3c, 0x01}
		,{0x6d, 0xff},{0x6e, 0x01}
		,{0x3b, 0x22},{0x3c, 0x03}
		,{0x28, 0xd9},{0x29, 0x00},{0x2a, 0x00},{0x2b, 0x81}
		,{0x40, 0x47},{0x41, 0x01}
		,{0x50, 0xd5},{0x51, 0x01}
		,{0x50, 0xd7},{0x51, 0xb7}
		,{0x52, 0x01}
		,{0x45, 0x04}
		,{0x50, 0x50},{0x51, 0x02}
		,{0x6d, 0xfb},{0x6e, 0xbf}
		,{0x50, 0xa7},{0x51, 0x00}
		,{0x50, 0xa8},{0x51, 0x0f}
		,{0x50, 0xa9},{0x51, 0xff}
		,{0x50, 0xaa},{0x51, 0x00}
		,{0x50, 0xab},{0x51, 0xff}
		,{0x50, 0xac},{0x51, 0xff}
		,{0x50, 0xad},{0x51, 0x00}
		,{0x50, 0xae},{0x51, 0xff}
		,{0x50, 0xaf},{0x51, 0xff}
		,{0x5e, 0x07}
		,{0x50, 0xdc},{0x51, 0x03}
		,{0x50, 0xdd},{0x51, 0xff}
		,{0x50, 0xde},{0x51, 0x3f}
		,{0x50, 0xdf},{0x51, 0xff}
		,{0x50, 0xe0},{0x51, 0x3f}
		,{0x50, 0xe1},{0x51, 0xff}
		,{0x50, 0xb0},{0x51, 0x07}
		,{0x50, 0xb2},{0x51, 0x03}
		,{0x50, 0xb3},{0x51, 0xff}
		,{0x50, 0xb4},{0x51, 0x3f}
		,{0x50, 0xb5},{0x51, 0xff}
		,{0x50, 0xb6},{0x51, 0x3f}
		,{0x50, 0xb7},{0x51, 0xff}
		,{0x45, 0x04}
		,{0x50, 0x51},{0x51, 0x04}
		,{0x53, 0x00},{0x53, 0x07}
		,{0x5f, 0x00},{0x5f, 0x07}
		,{0x50, 0xb1},{0x51, 0x07},{0x51, 0x00}
		,{0x45, 0x14},{0x45, 0x04}
		,{0x50, 0x50},{0x51, 0x03},{0x51, 0x02}
		,{0x6d, 0x35},{0x6e, 0x07}
		,{0x50, 0xda},{0x51, 0xff}
		,{0x50, 0xdb},{0x51, 0x07}
		,{0xee, 0x03}
		,{0xec, 0xff}
		,{0xec, 0xff}
		,{0xee, 0x03}
		,{0xee, 0x02}
		,{0x39, 0x01}
		,{0x3b, 0x05},{0x3c, 0x01}
		,{0x3a, 0x15},{0x3a, 0x05}
		,{0x71, 0x00}
		};
	for ( unsigned int i = 0; i < TBL_SZ( tbl ); i++ ) {
		DeMod_Write(tbl[i][0], tbl[i][1]);
	}
}

void Ktv2Device::ResetDeMod ()
{
	static uint8_t tbl[][2] = {
		{0x08, 0x01}
		,{0x70, 0xf0}
		,{0x70, 0xff}
		,{0x08, 0x00}
		,{0xe7, 0x01}
		,{0xe6, 0x20}
		,{0xe6, 0x21}
		};
	for ( unsigned int i = 0; i < TBL_SZ( tbl ); i++ ) {
		DeMod_Write(tbl[i][0], tbl[i][1]);
	}
}
/* */
#include "em2874-card.hpp"

int
KtvCardReset(const void *pCardDev)
{
	EM2874Device *pDev = (EM2874Device *)pCardDev;

	/* 初期化済 */
	if(pDev->isCardReady)
		return 0;

#ifdef DEBUG_CAS
	std::cerr << "CAS Reset(";
#endif
	bool bRet = pDev->resetICC();
#ifdef DEBUG_CAS
	std::cerr << bRet << ")";
#endif
	return bRet ? 0 : -1;
}
int
KtvCardTransmit(const void *pCardDev, const void *pSend, const size_t nSendLen, void *pRecv, size_t *nRecvLen)
{
	bool bRet;
	int ret;
	EM2874Device *pDev = (EM2874Device *)pCardDev;

#ifdef DEBUG_CAS
	std::cerr << "CAS Write(" <<  nSendLen << ")";
#endif
	bRet = pDev->writeICC(nSendLen, pSend);
#ifdef DEBUG_CAS
	if(bRet) std::cerr << ".";
#endif
	if(!bRet) return 1;
	miliWait(30);
	ret = pDev->waitICC();
	if(ret < 0)
	{
#ifdef DEBUG_CAS
	if(bRet) std::cerr << "waitCASerr=" << ret;
#endif
		return 2;
	}
	size_t rlen = (*nRecvLen > 254) ? 254 : *nRecvLen;
#ifdef DEBUG_CAS
	std::cerr << "CAS Read";
#endif
	bRet = pDev->readICC(&rlen, pRecv);
	*nRecvLen = bRet ? rlen : 0;
#ifdef DEBUG_CAS
	std::cerr << "(" <<  *nRecvLen << ")";
#endif
	return bRet ? 0 : 3;
}

/* */

